#!/usr/bin/env python
# @Author: Adeel Ahmad

import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
from io import BytesIO
import healpy as hp
import astropy as ast

# Rule followed: Tile N in order K -> NorderK / DirD / NpixN{.ext}
S = 9  # 512 X 512 tile size assumed
survey = 'DSSColor'
HEALPix_cell = '90231'
order = str(int(np.floor(np.log2(int(HEALPix_cell)) - S)))
angular_resolution = None
D = str(np.around(int(HEALPix_cell), decimals=-(len(HEALPix_cell) - 1)))

# using pixels
# Nside = hp.npix2nside(12*65536) # <-- not sure if this is correct?
# print(Nside)

# using order
Nside = hp.order2nside(int(order)) # <-- not sure if this is correct?
print(Nside)

angle = hp.pix2ang(Nside, int(HEALPix_cell))
print(angle)

pixel = hp.ang2pix(Nside, angle[0], angle[1])
print(pixel)

vector = hp.ang2vec(angle[0], angle[1])
print(vector)

# vector_angle = hp.vec2ang(np.array([3.06161700e-16,  -5.00000000e+00,  12.]))
vector_angle = hp.vec2ang(np.array([359.79277001, -0.09022235,  0.99590526]))
print(vector_angle)

pixel = hp.ang2pix(Nside, vector_angle[0], vector_angle[1])
HEALPix_cell = str(pixel)
print(pixel)


from astropy.coordinates import get_sun
from astropy.time import Time
t=Time('2016-03-20 4:30:00')
print(get_sun(t))

# convert from geo centric to angle, and then map to pixel

base_url = 'http://alasky.u-strasbg.fr/DSS/' + survey \
           + '/Norder' + order + '/Dir' + D + '/Npix' + HEALPix_cell + '.jpg'
# print(base_url)
# base_url = 'http://alasky.u-strasbg.fr/DSS/DSSColor/Norder7/Dir90000/Npix91422.jpg'

print('Choose a library for retreiving HiPS data: \n1. URLlib\n2. Requests')
choice = input('Enter your choice: ')

if (choice is '1'):
    import urllib.request

    data = urllib.request.urlopen(base_url).read()
elif (choice is '2'):
    import requests

    data = requests.get(base_url).content
else:
    print('Invalid choice')

plt.imshow(Image.open(BytesIO(data)))
plt.show()

# For parsing a TSV file
# phot_g_n_obs = []
# with open('../data.tsv') as tsvfile:
#     reader = csv.DictReader(tsvfile, delimiter='\t')
#     for row in reader:
#         phot_g_n_obs.append(int(row['phot_g_n_obs']))
#